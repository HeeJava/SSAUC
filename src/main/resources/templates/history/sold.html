<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
    <meta charset="UTF-8">
    <title>판매 내역 상세</title>
    <!-- 필요한 CSS, JS, CDN 등 -->
    <link rel="stylesheet" href="/css/mypage.css">
    <style>
        .col-md-10 {
            padding-left: 80px;
            padding-top: 24px;
        }
        /* 캐러셀 전체 영역 및 각 슬라이드의 고정 높이 설정 */
        .carousel-inner,
        .carousel-item {
            height: 400px;
            width: 400px;
        }
        /* 캐러셀 슬라이드 이미지 스타일 */
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .tracking-number {
            margin-top: 16px;
        }
    </style>
</head>
<body>
<div class="container" layout:fragment="content">
    <div class="row">
        <!-- 왼쪽 Sidebar (mypage 그대로) -->
        <div class="sidebar" th:replace="~{mypage/mypage :: sidebar}"></div>
        <!-- 오른쪽 메인 컨텐츠 -->
        <div class="col-md-10">
            <h2 class="mb-4">판매 내역 상세</h2>

            <!-- Section 1: 직거래 및 배송 장소 (Product Info) -->
            <div class="card mb-4">
                <div class="card-header fw-bold">판매 상품 정보</div>
                <div class="card-body">
                    <div class="row">
                        <!-- 왼쪽: 상품 정보 -->
                        <div class="col-md-7">
                            <p><strong>상품 이름:</strong> <span th:text="${soldDetail.productName}">상품 A</span></p>
                            <p><strong>경매 시작가:</strong> <span th:text="${soldDetail.startPrice}">10000</span></p>
                            <p><strong>등록 시간:</strong> <span
                                    th:text="${#temporals.format(soldDetail.createdAt, 'yyyy-MM-dd HH:mm:ss')}">2025-02-05 14:30:00</span>
                            </p>
                            <p><strong>거래 방식:</strong> <span
                                    th:text="${soldDetail.dealType == 0 ? '🧑🏻 직거래' : (soldDetail.dealType == 1 ? '🚚 택배거래' : '🧑🏻🚚 직거래, 택배거래')}">거래 방식</span>
                            </p>
                            <hr>
                            <p><strong>구매자:</strong> <span th:text="${soldDetail.buyerName}">구매자123</span></p>
                            <p><strong>판매가:</strong> <span th:text="${soldDetail.totalPrice}">50,000 원</span></p>
                            <p><strong>판매 시간:</strong> <span
                                    th:text="${#temporals.format(soldDetail.orderDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 16:45:00</span>
                            </p>
                            <p><strong>거래 완료 시간:</strong> <span
                                    th:text="${#temporals.format(soldDetail.completedDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 17:00:00</span>
                            </p>
                        </div>
                        <!-- 오른쪽: 상품 이미지 Carousel -->
                        <div class="col-md-5">
                            <div id="carouselSold" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    <div th:each="image, iterStat : ${carouselImages}"
                                         class="carousel-item"
                                         th:classappend="${iterStat.index == 0} ? ' active' : ''">
                                        <img th:src="@{${image.url}}" class="d-block w-100" th:alt="${image.alt}"/>
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselSold"
                                        data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">이전</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselSold"
                                        data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">다음</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: 배송지, 수령인 정보 및 운송장 등록 -->
            <div class="card mb-4">
                <div class="card-header fw-bold">배송 요청 정보</div>
                <div class="card-body">
                    <p><strong>수령인 이름:</strong> <span th:text="${soldDetail.recipientName}">홍길동</span></p>
                    <p><strong>수령인 연락처:</strong> <span th:text="${soldDetail.recipientPhone}">010-1234-5678</span></p>
                    <p><strong>우편번호:</strong> <span th:text="${soldDetail.postalCode}">12345</span></p>
                    <p><strong>배송 주소:</strong> <span th:text="${soldDetail.deliveryAddress}">서울특별시 강남구 테헤란로 123</span>
                    </p>
                    <!-- 운송장 등록 영역 -->
                    <div class="tracking mt-3">
                        <span class="fw-bold">운송장 등록 현황:</span>
                        <button class="btn btn-primary btn-sm" onclick="registerTracking()"
                                th:text="${soldDetail.deliveryStatus != null} ? '운송장 수정' : '운송장 등록'">
                            운송장 등록
                        </button>
                        <p class="tracking-number">
                            <strong>등록된 운송장 번호:</strong>
                            <span id="trackingNo" th:text="${soldDetail.deliveryStatus}"></span>
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script layout:fragment="script" th:inline="javascript">

    function registerTracking() {
        const newTracking = prompt("운송장 번호를 입력하세요:");
        if (newTracking && newTracking.trim() !== "") {
            const orderId = /*[[${soldDetail.orderId}]]*/ 0;
            fetch('/history/sold/update-tracking?orderId=' + orderId + '&newTracking=' + encodeURIComponent(newTracking.trim()), {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.updated) {
                        document.getElementById("trackingNo").textContent = newTracking.trim();
                        document.querySelector('button[onclick="registerTracking()"]').textContent = "운송장 수정";
                        alert("운송장 번호가 업데이트되었습니다.");
                    } else {
                        alert("운송장 번호 업데이트에 실패했습니다.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("오류가 발생했습니다.");
                });
        }
    }

</script>
</body>
</html>
